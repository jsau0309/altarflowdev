generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model IdempotencyCache {
  key          String   @id @db.VarChar(255)
  responseData String
  expiresAt    DateTime

  @@index([expiresAt])
  @@map("idempotency_cache")
}

model Donor {
  id               String                @id @default(cuid())
  firstName        String?
  lastName         String?
  email            String?               @unique
  addressLine1     String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  addressLine2     String?
  city             String?
  country          String?
  isPhoneVerified  Boolean               @default(false)
  phone            String?               @unique
  postalCode       String?
  state            String?
  stripeCustomerId String?
  memberId         String?               @db.Uuid
  churchId         String?               @db.Uuid
  transactions     DonationTransaction[]
  church           Church?               @relation("DonorToChurch", fields: [churchId], references: [id])
  member           Member?               @relation("DonorToMember", fields: [memberId], references: [id])

  @@index([memberId])
  @@index([churchId])
}

model Church {
  id                   String                @id @default(uuid()) @db.Uuid
  name                 String
  address              String?
  phone                String?
  email                String?
  website              String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now()) @updatedAt
  clerkOrgId           String?               @unique
  ministriesJson       Json?                 @db.Json
  serviceTimesJson     Json?                 @db.Json
  settingsJson         Json?                 @db.Json
  slug                 String                @unique
  campaigns            Campaign[]
  donations            Donation[]
  donationTransactions DonationTransaction[]
  donationTypes        DonationType[]
  donors               Donor[]               @relation("DonorToChurch")
  expenses             Expense[]
  flows                Flow[]
  members              Member[]
  stripeConnectAccount StripeConnectAccount?
}

model DonationType {
  id                 String                @id @default(cuid())
  churchId           String                @db.Uuid
  name               String
  description        String?
  isRecurringAllowed Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  donations          DonationTransaction[]
  church             Church                @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, name])
  @@index([churchId])
}

model DonationTransaction {
  id                          String       @id @default(cuid())
  churchId                    String       @db.Uuid
  donationTypeId              String
  donorClerkId                String?
  donorName                   String?
  donorEmail                  String?
  amount                      Int
  currency                    String
  status                      String
  paymentMethodType           String?
  isRecurring                 Boolean      @default(false)
  stripePaymentIntentId       String?      @unique
  stripeSubscriptionId        String?      @unique
  stripeCustomerId            String?
  transactionDate             DateTime     @default(now())
  processedAt                 DateTime?
  idempotencyKey              String?      @unique
  processingFeeCoveredByDonor Int?         @default(0)
  donorId                     String?
  source                      String       @default("stripe")
  createdAt                   DateTime     @default(now())
  editHistory                 Json?
  editReason                  String?
  lastEditedAt                DateTime?
  lastEditedBy                String?
  originalAmount              Int?
  church                      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  donationType                DonationType @relation(fields: [donationTypeId], references: [id])
  donor                       Donor?       @relation(fields: [donorId], references: [id])

  @@index([churchId])
  @@index([donationTypeId])
  @@index([donorClerkId])
  @@index([stripePaymentIntentId])
  @@index([stripeSubscriptionId])
  @@index([donorId])
  @@index([churchId, transactionDate])
  @@index([paymentMethodType])
  @@index([status])
}

model Profile {
  id                 String    @id
  firstName          String?
  lastName           String?
  churchName         String?
  role               Role      @default(STAFF)
  onboardingComplete Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  email              String?
  approvedExpenses   Expense[] @relation("ApprovedExpenses")
  submittedExpenses  Expense[] @relation("SubmittedExpenses")
}

model Member {
  id                         String            @id @default(uuid()) @db.Uuid
  firstName                  String
  lastName                   String
  email                      String?           @unique
  phone                      String?
  address                    String?
  city                       String?
  state                      String?
  zipCode                    String?
  joinDate                   DateTime?
  smsConsent                 Boolean           @default(false)
  smsConsentDate             DateTime?
  smsConsentMethod           String?
  language                   String?
  churchId                   String            @db.Uuid
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @default(now()) @updatedAt
  lastSubmittedConnectFormAt DateTime?
  membershipStatus           MembershipStatus?
  notes                      String?
  life_stage                 String?
  ministry_interests         String[]          @default([])
  preferred_service_times    String[]          @default([])
  donations                  Donation[]
  linkedDonors               Donor[]           @relation("DonorToMember")
  church                     Church            @relation(fields: [churchId], references: [id])
  submissions                Submission[]

  @@index([churchId])
  @@index([churchId, joinDate])
  @@index([churchId, membershipStatus])
}

model Campaign {
  id          String     @id @default(uuid()) @db.Uuid
  name        String
  description String?
  goalAmount  Decimal?   @db.Decimal(10, 2)
  startDate   DateTime?
  endDate     DateTime?
  churchId    String     @db.Uuid
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt
  church      Church     @relation(fields: [churchId], references: [id])
  donations   Donation[]

  @@index([churchId])
}

model Donation {
  id                    String    @id @default(uuid()) @db.Uuid
  amount                Decimal   @db.Decimal(10, 2)
  currency              String    @default("USD")
  donationDate          DateTime  @default(now())
  donorFirstName        String?
  donorLastName         String?
  donorEmail            String?
  memberId              String?   @db.Uuid
  campaignId            String?   @db.Uuid
  churchId              String    @db.Uuid
  stripePaymentIntentId String?   @unique
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt
  campaign              Campaign? @relation(fields: [campaignId], references: [id])
  church                Church    @relation(fields: [churchId], references: [id])
  member                Member?   @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([campaignId])
  @@index([churchId])
}

model Expense {
  id          String        @id @default(cuid())
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("USD")
  expenseDate DateTime
  category    String
  vendor      String?
  description String?
  receiptUrl  String?
  receiptPath String?
  status      ExpenseStatus @default(PENDING)
  submitterId String
  approverId  String?
  churchId    String        @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt
  approver    Profile?      @relation("ApprovedExpenses", fields: [approverId], references: [id])
  church      Church        @relation(fields: [churchId], references: [id])
  submitter   Profile       @relation("SubmittedExpenses", fields: [submitterId], references: [id])

  @@index([submitterId])
  @@index([approverId])
  @@index([churchId])
  @@index([churchId, expenseDate])
  @@index([status])
}

model StripeConnectAccount {
  id                         String    @id @default(uuid()) @db.Uuid
  stripeAccountId            String    @unique
  churchId                   String    @unique
  chargesEnabled             Boolean   @default(false)
  detailsSubmitted           Boolean   @default(false)
  payoutsEnabled             Boolean   @default(false)
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  metadata                   Json?     @db.Json
  requirementsCurrentlyDue   String[]  @default([])
  requirementsDisabledReason String?
  requirementsEventuallyDue  String[]  @default([])
  tosAcceptanceDate          DateTime?
  verificationStatus         String    @default("unverified")
  church                     Church    @relation(fields: [churchId], references: [clerkOrgId], onDelete: Cascade)

  @@index([churchId])
}

model Flow {
  id          String       @id @default(cuid())
  name        String
  type        FlowType     @default(NEW_MEMBER)
  slug        String       @unique
  configJson  Json
  isEnabled   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  churchId    String       @db.Uuid
  church      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@unique([churchId, type], name: "church_flow_type_unique")
  @@index([churchId])
  @@index([churchId, slug])
}

model Submission {
  id           String   @id @default(cuid())
  submittedAt  DateTime @default(now())
  formDataJson Json
  memberId     String?  @db.Uuid
  flowId       String
  flow         Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  member       Member?  @relation(fields: [memberId], references: [id])

  @@index([flowId])
  @@index([memberId])
}

enum MembershipStatus {
  Visitor
  Member
  Inactive
}

enum Role {
  ADMIN
  STAFF
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FlowType {
  NEW_MEMBER
  EVENT_SIGNUP
  SURVEY
}
