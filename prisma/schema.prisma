generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Church {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String
  address              String?
  phone                String?
  email                String?
  website              String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now())
  clerkOrgId           String?               @unique
  ministriesJson       Json?                 @db.Json
  serviceTimesJson     Json?                 @db.Json
  settingsJson         Json?                 @db.Json
  slug                 String                @unique
  onboardingCompleted  Boolean               @default(false)
  onboardingStep       Int                   @default(1)
  stripeCustomerId     String?               @unique
  subscriptionEndsAt   DateTime?
  subscriptionId       String?               @unique
  subscriptionPlan     String?
  subscriptionStatus   String                @default("pending_payment")
  trialEndsAt          DateTime?
  setupFeePaid         Boolean               @default(false)
  setupFeeAmount       Int?
  setupFeePaidAt       DateTime?
  freeTrialStartedAt      DateTime?
  promotionalEndsAt       DateTime?
  promotionalCouponId     String?
  DonationTransaction     DonationTransaction[]
  DonationType            DonationType[]
  DonationPaymentMethod   DonationPaymentMethod[]
  Donor                   Donor[]
  ExpenseCategory         ExpenseCategory[]
  Event                Event[]
  Expense              Expense[]
  Flow                 Flow[]
  LandingPageConfig    LandingPageConfig?
  Member               Member[]
  PayoutSummary        PayoutSummary[]
  StripeConnectAccount StripeConnectAccount?

  @@index([clerkOrgId])
  @@index([slug])
  @@index([subscriptionStatus])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model DonationTransaction {
  id                          String       @id @default(cuid())
  churchId                    String       @db.Uuid
  donationTypeId              String
  donorName                   String?
  donorEmail                  String?
  amount                      Int
  currency                    String
  status                      String
  paymentMethodType           String?      // Legacy field for Stripe payment methods
  paymentMethodId             String?      // New relation to DonationPaymentMethod for manual donations
  isRecurring                 Boolean      @default(false)
  stripePaymentIntentId       String?      @unique
  stripeSubscriptionId        String?      @unique
  stripeCustomerId            String?
  transactionDate             DateTime     @default(now())
  processedAt                 DateTime?
  idempotencyKey              String?      @unique
  processingFeeCoveredByDonor Int?         @default(0)
  donorId                     String?
  source                      String       @default("stripe")
  createdAt                   DateTime     @default(now())
  editHistory                 Json?
  editReason                  String?
  lastEditedAt                DateTime?
  lastEditedBy                String?
  originalAmount              Int?
  refundedAmount              Int?         @default(0)
  refundedAt                  DateTime?
  disputeStatus               String?
  disputeReason               String?
  disputedAt                  DateTime?
  isAnonymous                 Boolean      @default(false)
  isInternational             Boolean      @default(false)
  donorCountry                String?
  platformFeeAmount           Int?         @default(0)
  donorLanguage               String?      @default("en")
  Church                      Church                 @relation(fields: [churchId], references: [id], onDelete: Cascade)
  DonationType                DonationType           @relation(fields: [donationTypeId], references: [id])
  DonationPaymentMethod       DonationPaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  Donor                       Donor?                 @relation(fields: [donorId], references: [id])

  @@index([churchId])
  @@index([churchId, transactionDate])
  @@index([disputeStatus])
  @@index([donationTypeId])
  @@index([donorId])
  @@index([paymentMethodType])
  @@index([paymentMethodId])
  @@index([stripePaymentIntentId], map: "idx_donation_transaction_stripe")
  @@index([churchId, createdAt(sort: Desc)], map: "idx_donations_church_date")
  @@index([churchId, donationTypeId, createdAt(sort: Desc)], map: "idx_donations_church_fund_date")
  @@index([churchId], map: "idx_donation_transaction_church")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model DonationType {
  id                  String                @id @default(dbgenerated("(gen_random_uuid())::text"))
  churchId            String                @db.Uuid
  name                String
  description         String?
  isRecurringAllowed  Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  isCampaign          Boolean               @default(false)
  goalAmount          Decimal?              @db.Decimal(10, 2)
  startDate           DateTime?
  endDate             DateTime?
  isActive            Boolean               @default(true)
  isSystemType        Boolean               @default(false)
  isDeletable         Boolean               @default(true)
  DonationTransaction DonationTransaction[]
  Church              Church                @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, name])
  @@index([churchId, isCampaign])
  @@index([churchId], map: "idx_donation_type_church")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Donor {
  id                  String                @id @default(cuid())
  firstName           String?
  lastName            String?
  email               String?               @unique
  addressLine1        String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  addressLine2        String?
  city                String?
  country             String?
  isPhoneVerified     Boolean               @default(false)
  phone               String?               @unique
  postalCode          String?
  state               String?
  stripeCustomerId    String?
  memberId            String?               @db.Uuid
  churchId            String?               @db.Uuid
  DonationTransaction DonationTransaction[]
  Church              Church?               @relation(fields: [churchId], references: [id])
  Member              Member?               @relation(fields: [memberId], references: [id])

  @@index([churchId])
  @@index([memberId])
  @@index([churchId], map: "idx_donor_church")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model DonationPaymentMethod {
  id                  String                @id @default(cuid())
  churchId            String                @db.Uuid
  name                String
  color               String                @default("#10B981") // Default green color
  isSystemMethod      Boolean               @default(false)
  isDeletable         Boolean               @default(true)
  isHidden            Boolean               @default(false) // Allow hiding system methods
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  DonationTransaction DonationTransaction[]
  Church              Church                @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, name])
  @@index([churchId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ExpenseCategory {
  id              String    @id @default(cuid())
  churchId        String    @db.Uuid
  name            String
  color           String    @default("#6B7280") // Default gray color
  isSystemCategory Boolean  @default(false)
  isDeletable     Boolean   @default(true)
  isHidden        Boolean   @default(false) // Allow hiding system categories
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  Expense         Expense[]
  Church          Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, name])
  @@index([churchId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Expense {
  id                                   String           @id @default(cuid())
  amount                               Decimal          @db.Decimal(10, 2)
  currency                             String           @default("USD")
  expenseDate                          DateTime
  category                             String?          // Legacy field, kept for backward compatibility
  expenseCategoryId                    String?          // New relation to ExpenseCategory
  vendor                               String?
  description                          String?
  receiptUrl                           String?
  receiptPath                          String?
  status                               ExpenseStatus    @default(PENDING)
  submitterId                          String
  approverId                           String?
  churchId                             String           @db.Uuid
  createdAt                            DateTime         @default(now())
  updatedAt                            DateTime         @default(now())
  ExpenseCategory                      ExpenseCategory? @relation(fields: [expenseCategoryId], references: [id])
  Profile_Expense_approverIdToProfile  Profile?         @relation("Expense_approverIdToProfile", fields: [approverId], references: [id])
  Church                               Church           @relation(fields: [churchId], references: [id])
  Profile_Expense_submitterIdToProfile Profile          @relation("Expense_submitterIdToProfile", fields: [submitterId], references: [id])

  @@index([churchId, expenseDate])
  @@index([churchId])
  @@index([submitterId])
  @@index([expenseCategoryId])
  @@index([churchId, expenseDate(sort: Desc)], map: "idx_expenses_church_date")
  @@index([churchId, createdAt], map: "idx_expense_church_date")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Flow {
  id         String       @id @default(cuid())
  name       String
  type       FlowType     @default(NEW_MEMBER)
  slug       String       @unique
  configJson Json
  isEnabled  Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime
  churchId   String       @db.Uuid
  customSlug String?      @unique
  Church     Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  Submission Submission[]

  @@unique([churchId, type])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Member {
  id                         String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName                  String
  lastName                   String
  email                      String?
  phone                      String?
  address                    String?
  city                       String?
  state                      String?
  zipCode                    String?
  joinDate                   DateTime?
  smsConsent                 Boolean           @default(false)
  smsConsentDate             DateTime?
  smsConsentMethod           String?
  language                   String?
  churchId                   String            @db.Uuid
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @default(now())
  lastSubmittedConnectFormAt DateTime?
  membershipStatus           MembershipStatus?
  notes                      String?
  life_stage                 String?
  ministry_interests         String[]          @default([])
  preferred_service_times    String[]          @default([])
  Donor                      Donor[]
  Church                     Church            @relation(fields: [churchId], references: [id])
  Submission                 Submission[]

  @@unique([churchId, email])
  @@index([churchId])
  @@index([churchId, joinDate])
  @@index([churchId, email], map: "idx_members_church_email")
  @@index([churchId, membershipStatus], map: "idx_members_church_status")
  @@index([churchId, email], map: "idx_member_church_email")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PayoutSummary {
  id               String    @id @default(cuid())
  stripePayoutId   String    @unique
  churchId         String    @db.Uuid
  payoutDate       DateTime
  arrivalDate      DateTime
  amount           Int
  currency         String    @default("usd")
  transactionCount Int       @default(0)
  grossVolume      Int       @default(0)
  totalFees        Int       @default(0)
  totalRefunds     Int       @default(0)
  totalDisputes    Int       @default(0)
  netAmount        Int
  status           String
  failureReason    String?
  payoutSchedule   String?
  reconciledAt     DateTime?
  bankReference    String?
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  Church           Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId, payoutDate])
  @@index([payoutDate])
  @@index([churchId], map: "idx_payout_summary_church")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Profile {
  id                                   String    @id @default(cuid())
  firstName                            String?
  lastName                             String?
  churchName                           String?
  role                                 Role      @default(STAFF)
  onboardingComplete                   Boolean   @default(false)
  createdAt                            DateTime  @default(now())
  updatedAt                            DateTime  @default(now())
  email                                String?
  Expense_Expense_approverIdToProfile  Expense[] @relation("Expense_approverIdToProfile")
  Expense_Expense_submitterIdToProfile Expense[] @relation("Expense_submitterIdToProfile")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model StripeConnectAccount {
  id                         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  stripeAccountId            String    @unique
  churchId                   String    @unique
  chargesEnabled             Boolean   @default(false)
  detailsSubmitted           Boolean   @default(false)
  payoutsEnabled             Boolean   @default(false)
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime
  metadata                   Json?     @db.Json
  requirementsCurrentlyDue   String[]  @default([])
  requirementsDisabledReason String?
  requirementsEventuallyDue  String[]  @default([])
  tosAcceptanceDate          DateTime?
  verificationStatus         String    @default("unverified")
  paymentDomainsRegistered   Boolean   @default(false)
  paymentDomainsRegisteredAt DateTime?
  registeredDomains          String[]  @default([])
  Church                     Church    @relation(fields: [churchId], references: [clerkOrgId], onDelete: Cascade)

  @@index([churchId], map: "idx_stripe_connect_church")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Submission {
  id           String   @id @default(cuid())
  submittedAt  DateTime @default(now())
  formDataJson Json
  memberId     String?  @db.Uuid
  flowId       String
  Flow         Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  Member       Member?  @relation(fields: [memberId], references: [id])

  @@index([flowId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model idempotency_cache {
  key          String   @id @db.VarChar(255)
  responseData String
  expiresAt    DateTime
}

/// Landing page customization settings for churches
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model LandingPageConfig {
  id                    String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  churchId              String         @unique @db.Uuid
  logoUrl               String?
  logoPath              String?
  description           String?
  backgroundType        BackgroundType @default(PRESET)
  backgroundValue       String?
  socialLinks           Json?          @db.Json
  showDonateButton      Boolean        @default(false)
  showConnectButton     Boolean        @default(false)
  donateButtonText      String         @default("Donate")
  connectButtonText     String         @default("Connect")
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @default(now()) @updatedAt
  customTitle           String?
  titleFont             String         @default("Modern")
  titleSize             String         @default("Large")
  titleColor            String         @default("#1F2937")
  buttonBackgroundColor String?        @default("#FFFFFF")
  buttonTextColor       String?        @default("#1F2937")
  buttons               Json?
  announcementText      String?
  announcementLink      String?
  showAnnouncement      Boolean        @default(false)
  ogBackgroundColor     String?        @default("#3B82F6")
  eventTitleColor       String         @default("#FFFFFF")
  eventDetailsColor     String         @default("#FFFFFF")
  Church                Church         @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
}

/// This model stores events that churches can display on their landing pages
model Event {
  id          String   @id @default(uuid()) @db.Uuid
  churchId    String   @db.Uuid
  title       String
  description String
  eventDate   DateTime
  eventTime   String
  address     String
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([churchId])
  @@index([churchId, eventDate])
}

enum BackgroundType {
  PRESET
  GRADIENT
  SOLID
  IMAGE
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FlowType {
  NEW_MEMBER
  EVENT_SIGNUP
  SURVEY
}

enum MembershipStatus {
  Visitor
  Member
  Inactive
}

enum Role {
  ADMIN
  STAFF
}
