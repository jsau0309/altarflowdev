generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model IdempotencyCache {
  key          String   @id @db.VarChar(255)
  responseData String
  expiresAt    DateTime

  @@index([expiresAt])
  @@map("idempotency_cache")
}

model Donor {
  id               String                @id @default(cuid())
  firstName        String?
  lastName         String?
  email            String?               @unique
  addressLine1     String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  addressLine2     String?
  city             String?
  country          String?
  isPhoneVerified  Boolean               @default(false)
  phone            String?               @unique
  postalCode       String?
  state            String?
  stripeCustomerId String?
  memberId         String?               @db.Uuid
  churchId         String?               @db.Uuid
  transactions     DonationTransaction[]
  church           Church?               @relation("DonorToChurch", fields: [churchId], references: [id])
  member           Member?               @relation("DonorToMember", fields: [memberId], references: [id])

  @@index([memberId])
  @@index([churchId])
}

model Church {
  id                   String                @id @default(uuid()) @db.Uuid
  name                 String
  address              String?
  phone                String?
  email                String?
  website              String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @default(now()) @updatedAt
  clerkOrgId           String?               @unique
  ministriesJson       Json?                 @db.Json
  serviceTimesJson     Json?                 @db.Json
  settingsJson         Json?                 @db.Json
  slug                 String                @unique
  // Onboarding fields
  onboardingCompleted  Boolean               @default(false)
  onboardingStep       Int                   @default(1)
  // Billing fields for Stripe integration
  subscriptionId       String?               @unique
  subscriptionStatus   String                @default("pending_payment") // pending_payment, active, past_due, canceled
  subscriptionPlan     String?               // monthly, annual
  trialEndsAt          DateTime?
  subscriptionEndsAt   DateTime?
  stripeCustomerId     String?               @unique
  campaigns            Campaign[]
  donations            Donation[]
  donationTransactions DonationTransaction[]
  donationTypes        DonationType[]
  donors               Donor[]               @relation("DonorToChurch")
  expenses             Expense[]
  flows                Flow[]
  members              Member[]
  stripeConnectAccount StripeConnectAccount?
  emailCampaigns       EmailCampaign[]
  emailQuota           EmailQuota[]
  emailSettings        EmailSettings?
  payoutSummaries      PayoutSummary[]
}

model DonationType {
  id                 String                @id @default(cuid())
  churchId           String                @db.Uuid
  name               String
  description        String?
  isRecurringAllowed Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  donations          DonationTransaction[]
  church             Church                @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, name])
  @@index([churchId])
}

model DonationTransaction {
  id                          String       @id @default(cuid())
  churchId                    String       @db.Uuid
  donationTypeId              String
  donorClerkId                String?
  donorName                   String?
  donorEmail                  String?
  amount                      Int
  currency                    String
  status                      String
  paymentMethodType           String?
  isRecurring                 Boolean      @default(false)
  stripePaymentIntentId       String?      @unique
  stripeSubscriptionId        String?      @unique
  stripeCustomerId            String?
  transactionDate             DateTime     @default(now())
  processedAt                 DateTime?
  idempotencyKey              String?      @unique
  processingFeeCoveredByDonor Int?         @default(0)
  donorId                     String?
  source                      String       @default("stripe")
  createdAt                   DateTime     @default(now())
  editHistory                 Json?
  editReason                  String?
  lastEditedAt                DateTime?
  lastEditedBy                String?
  originalAmount              Int?
  // Refund tracking fields
  refundedAmount              Int?         @default(0)
  refundedAt                  DateTime?
  // Dispute tracking fields
  disputeStatus               String?
  disputeReason               String?
  disputedAt                  DateTime?
  church                      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  donationType                DonationType @relation(fields: [donationTypeId], references: [id])
  donor                       Donor?       @relation(fields: [donorId], references: [id])

  @@index([churchId])
  @@index([donationTypeId])
  @@index([donorClerkId])
  @@index([stripePaymentIntentId])
  @@index([stripeSubscriptionId])
  @@index([donorId])
  @@index([churchId, transactionDate])
  @@index([paymentMethodType])
  @@index([status])
  @@index([refundedAt])
  @@index([disputeStatus])
}

model Profile {
  id                 String    @id
  firstName          String?
  lastName           String?
  churchName         String?
  role               Role      @default(STAFF)
  onboardingComplete Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt
  email              String?
  approvedExpenses   Expense[] @relation("ApprovedExpenses")
  submittedExpenses  Expense[] @relation("SubmittedExpenses")
}

model Member {
  id                         String            @id @default(uuid()) @db.Uuid
  firstName                  String
  lastName                   String
  email                      String?
  phone                      String?
  address                    String?
  city                       String?
  state                      String?
  zipCode                    String?
  joinDate                   DateTime?
  smsConsent                 Boolean           @default(false)
  smsConsentDate             DateTime?
  smsConsentMethod           String?
  language                   String?
  churchId                   String            @db.Uuid
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @default(now()) @updatedAt
  lastSubmittedConnectFormAt DateTime?
  membershipStatus           MembershipStatus?
  notes                      String?
  life_stage                 String?
  ministry_interests         String[]          @default([])
  preferred_service_times    String[]          @default([])
  donations                  Donation[]
  linkedDonors               Donor[]           @relation("DonorToMember")
  church                     Church            @relation(fields: [churchId], references: [id])
  submissions                Submission[]
  emailRecipients            EmailRecipient[]
  emailPreference            EmailPreference?

  @@unique([churchId, email])
  @@index([churchId])
  @@index([churchId, joinDate])
  @@index([churchId, membershipStatus])
}

model Campaign {
  id          String     @id @default(uuid()) @db.Uuid
  name        String
  description String?
  goalAmount  Decimal?   @db.Decimal(10, 2)
  startDate   DateTime?
  endDate     DateTime?
  churchId    String     @db.Uuid
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now()) @updatedAt
  church      Church     @relation(fields: [churchId], references: [id])
  donations   Donation[]

  @@index([churchId])
}

model Donation {
  id                    String    @id @default(uuid()) @db.Uuid
  amount                Decimal   @db.Decimal(10, 2)
  currency              String    @default("USD")
  donationDate          DateTime  @default(now())
  donorFirstName        String?
  donorLastName         String?
  donorEmail            String?
  memberId              String?   @db.Uuid
  campaignId            String?   @db.Uuid
  churchId              String    @db.Uuid
  stripePaymentIntentId String?   @unique
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @default(now()) @updatedAt
  campaign              Campaign? @relation(fields: [campaignId], references: [id])
  church                Church    @relation(fields: [churchId], references: [id])
  member                Member?   @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@index([campaignId])
  @@index([churchId])
}

model Expense {
  id          String        @id @default(cuid())
  amount      Decimal       @db.Decimal(10, 2)
  currency    String        @default("USD")
  expenseDate DateTime
  category    String
  vendor      String?
  description String?
  receiptUrl  String?
  receiptPath String?
  status      ExpenseStatus @default(PENDING)
  submitterId String
  approverId  String?
  churchId    String        @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt
  approver    Profile?      @relation("ApprovedExpenses", fields: [approverId], references: [id])
  church      Church        @relation(fields: [churchId], references: [id])
  submitter   Profile       @relation("SubmittedExpenses", fields: [submitterId], references: [id])

  @@index([submitterId])
  @@index([approverId])
  @@index([churchId])
  @@index([churchId, expenseDate])
  @@index([status])
}

model StripeConnectAccount {
  id                         String    @id @default(uuid()) @db.Uuid
  stripeAccountId            String    @unique
  churchId                   String    @unique
  chargesEnabled             Boolean   @default(false)
  detailsSubmitted           Boolean   @default(false)
  payoutsEnabled             Boolean   @default(false)
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  metadata                   Json?     @db.Json
  requirementsCurrentlyDue   String[]  @default([])
  requirementsDisabledReason String?
  requirementsEventuallyDue  String[]  @default([])
  tosAcceptanceDate          DateTime?
  verificationStatus         String    @default("unverified")
  church                     Church    @relation(fields: [churchId], references: [clerkOrgId], onDelete: Cascade)

  @@index([churchId])
}

model Flow {
  id          String       @id @default(cuid())
  name        String
  type        FlowType     @default(NEW_MEMBER)
  slug        String       @unique
  customSlug  String?      @unique
  configJson  Json
  isEnabled   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  churchId    String       @db.Uuid
  church      Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  submissions Submission[]

  @@unique([churchId, type], name: "church_flow_type_unique")
  @@index([churchId])
  @@index([churchId, slug])
}

model Submission {
  id           String   @id @default(cuid())
  submittedAt  DateTime @default(now())
  formDataJson Json
  memberId     String?  @db.Uuid
  flowId       String
  flow         Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  member       Member?  @relation(fields: [memberId], references: [id])

  @@index([flowId])
  @@index([memberId])
}

enum MembershipStatus {
  Visitor
  Member
  Inactive
}

enum Role {
  ADMIN
  STAFF
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
}

enum FlowType {
  NEW_MEMBER
  EVENT_SIGNUP
  SURVEY
}

// Email Communication Models

model EmailCampaign {
  id                String              @id @default(cuid())
  churchId          String              @db.Uuid
  subject           String
  previewText       String?
  contentJson       Json                // Unlayer design JSON
  htmlContent       String?             // Generated HTML
  status            EmailStatus         @default(DRAFT)
  scheduledFor      DateTime?
  sentAt            DateTime?
  sentBy            String              // Clerk user ID
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Analytics
  totalRecipients   Int                 @default(0)
  sentCount         Int                 @default(0)
  deliveredCount    Int                 @default(0)
  bouncedCount      Int                 @default(0)
  unsubscribedCount Int                 @default(0)
  
  church            Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)
  recipients        EmailRecipient[]
  
  @@index([churchId])
  @@index([churchId, createdAt])
  @@index([status])
  @@index([scheduledFor])
}

model EmailRecipient {
  id              String           @id @default(cuid())
  campaignId      String
  memberId        String           @db.Uuid
  email           String
  status          RecipientStatus  @default(PENDING)
  sentAt          DateTime?
  deliveredAt     DateTime?
  bouncedAt       DateTime?
  bounceReason    String?
  unsubscribedAt  DateTime?
  failureReason   String?          // Reason for send failure
  resendEmailId   String?          // Resend tracking ID
  
  campaign        EmailCampaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  member          Member           @relation(fields: [memberId], references: [id])
  
  @@unique([campaignId, memberId])
  @@index([campaignId])
  @@index([memberId])
  @@index([email])
}

model EmailPreference {
  id                String    @id @default(cuid())
  memberId          String    @db.Uuid @unique
  email             String
  isSubscribed      Boolean   @default(true)
  unsubscribedAt    DateTime?
  unsubscribeToken  String    @unique @default(cuid())
  bounceCount       Int       @default(0)
  lastBouncedAt     DateTime?
  isEmailValid      Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  member            Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([email])
  @@index([unsubscribeToken])
}

model EmailQuota {
  id              String    @id @default(cuid())
  churchId        String    @db.Uuid
  monthYear       String    // Format: "2025-01"
  emailsSent      Int       @default(0) // Actually tracks campaigns sent, not individual emails
  quotaLimit      Int       @default(4) // 4 campaigns for free, 10000 for paid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  church          Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)
  
  @@unique([churchId, monthYear])
  @@index([churchId])
}

model EmailSettings {
  id              String    @id @default(cuid())
  churchId        String    @db.Uuid @unique
  senderName      String?   // e.g., "First Baptist Church"
  replyToEmail    String?   // Where replies should go
  timezone        String    @default("America/New_York")
  footerAddress   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  church          Church    @relation(fields: [churchId], references: [id], onDelete: Cascade)
}

enum EmailStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum RecipientStatus {
  PENDING
  SENT
  DELIVERED
  BOUNCED
  UNSUBSCRIBED
  FAILED
}

// Payout tracking for reconciliation
model PayoutSummary {
  id                  String       @id @default(cuid())
  stripePayoutId      String       @unique
  churchId            String       @db.Uuid
  payoutDate          DateTime     // When Stripe initiated the payout
  arrivalDate         DateTime     // Expected bank arrival date
  amount              Int          // Total payout amount in cents
  currency            String       @default("usd")
  transactionCount    Int          @default(0)
  grossVolume         Int          @default(0) // Total charges before fees
  totalFees           Int          @default(0) // Stripe fees
  totalRefunds        Int          @default(0) // Refunds deducted
  totalDisputes       Int          @default(0) // Disputes deducted
  netAmount           Int          // What actually gets deposited
  status              String       // pending/in_transit/paid/failed/canceled
  failureReason       String?      // If payout failed
  payoutSchedule      String?      // daily/weekly/monthly/manual
  reconciledAt        DateTime?    // When we reconciled with bank
  bankReference       String?      // Bank transaction reference
  metadata            Json?        // Additional Stripe metadata
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  church              Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  
  @@index([churchId])
  @@index([payoutDate])
  @@index([status])
  @@index([churchId, payoutDate])
}
